<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>NeuroVest Prime</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            --bg: #020617; --card: #0f172a; --accent: #38bdf8;
            --text: #f8fafc; --dim: #94a3b8; --border: rgba(255, 255, 255, 0.08);
            --success: #22c55e; --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { 
            height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between;
            background: var(--card); border-bottom: 1px solid var(--border);
        }
        .search-box { 
            background: var(--bg); border: 1px solid var(--border); border-radius: 8px; 
            display: flex; align-items: center; padding: 0 12px; width: 300px;
        }
        /* FIX: 16px font prevents iOS zoom */
        .search-box input { 
            background: transparent; border: none; color: white; padding: 10px; 
            font-size: 16px; width: 100%; outline: none; 
        }

        /* --- MAIN CONTENT --- */
        .main-container { display: grid; grid-template-columns: 1fr 340px; flex: 1; overflow: hidden; }
        
        /* FIX: TradingView needs a defined height/width container */
        #chart_container { background: #000; height: 100%; width: 100%; border-right: 1px solid var(--border); }

        .side-panel { background: var(--card); display: flex; flex-direction: column; padding: 20px; gap: 20px; border-left: 1px solid var(--border); }

        /* --- UI COMPONENTS --- */
        .price-card { background: var(--bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { 
            padding: 15px; border-radius: 8px; border: none; font-weight: 800; cursor: pointer; 
            font-size: 14px; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .buy { background: var(--success); color: white; }
        .sell { background: var(--danger); color: white; }

        /* --- BOTTOM TABS --- */
        .bottom-section { height: 250px; background: var(--bg); border-top: 1px solid var(--border); display: flex; flex-direction: column; }
        .tabs { display: flex; padding: 10px 20px; gap: 20px; border-bottom: 1px solid var(--border); }
        .tab { color: var(--dim); cursor: pointer; font-size: 12px; font-weight: 700; padding: 5px 0; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        .table-container { flex: 1; overflow-y: auto; padding: 10px 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; color: var(--dim); padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        td { padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.02); }

        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; }
            .side-panel { display: none; } /* Mobile optimization */
        }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: 900; color: var(--accent); font-size: 20px;">NEUROVEST</div>
        <div class="search-box">
            <i class="ph ph-magnifying-glass" style="color: var(--dim)"></i>
            <input type="text" id="tickerInput" placeholder="Enter Symbol..." onkeypress="if(event.key==='Enter') updateChart()">
        </div>
        <div id="balanceDisp" style="font-weight: 700;">$100,000.00</div>
    </header>

    <div class="main-container">
        <div id="chart_container"></div>

        <div class="side-panel">
            <div class="price-card">
                <div id="activeSym" style="font-size: 12px; color: var(--dim); letter-spacing: 1px;">NASDAQ:AAPL</div>
                <div id="livePrice" style="font-size: 32px; font-weight: 900; margin: 5px 0;">$0.00</div>
                <div id="liveChange" style="font-weight: 700; color: var(--success);">+0.00%</div>
            </div>

            <div>
                <label style="font-size: 10px; font-weight: 800; color: var(--dim);">SHARES</label>
                <input type="number" id="tradeQty" class="search-box" style="width: 100%; margin-top: 5px; color: white; background: var(--bg); font-size: 16px;" value="1">
            </div>

            <div class="btn-group">
                <button class="btn buy" onclick="trade('BUY')">BUY</button>
                <button class="btn sell" onclick="trade('SELL')">SELL</button>
            </div>
            
            <div style="margin-top: auto; font-size: 11px; color: var(--dim); line-height: 1.5; background: rgba(56,189,248,0.05); padding: 10px; border-radius: 8px;">
                <b>AI Oracle:</b> Looking at <span class="current-t">AAPL</span>. Volatility is low. Trend is bullish.
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('pos')">POSITIONS</div>
            <div class="tab" onclick="switchTab('hist')">HISTORY</div>
        </div>
        <div class="table-container">
            <table id="posTable">
                <thead><tr><th>Asset</th><th>Qty</th><th>Avg Cost</th><th>Value</th><th>P&L</th></tr></thead>
                <tbody id="posBody"></tbody>
            </table>
            <table id="histTable" style="display: none;">
                <thead><tr><th>Time</th><th>Type</th><th>Asset</th><th>Qty</th><th>Price</th></tr></thead>
                <tbody id="histBody"></tbody>
            </table>
        </div>
    </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        const API_KEY = "PQ6UXBMB968IQCIM";
        let state = JSON.parse(localStorage.getItem('nv_v3')) || { cash: 100000, portfolio: [], history: [] };
        let currentPrice = 0;
        let currentSym = "AAPL";

        // FIX: Ensure chart container is ready before loading
        function loadChart(symbol) {
            new TradingView.widget({
                "autosize": true, "symbol": symbol, "interval": "D", "timezone": "Etc/UTC",
                "theme": "dark", "style": "1", "locale": "en", "toolbar_bg": "#0f172a",
                "enable_publishing": false, "hide_top_toolbar": false, "container_id": "chart_container"
            });
            currentSym = symbol;
            document.getElementById('activeSym').innerText = symbol;
            fetchPrice(symbol);
        }

        async function fetchPrice(symbol) {
            try {
                const res = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${API_KEY}`);
                const data = await res.json();
                const q = data["Global Quote"];
                if(q) {
                    currentPrice = parseFloat(q["05. price"]);
                    document.getElementById('livePrice').innerText = `$${currentPrice.toFixed(2)}`;
                    document.getElementById('liveChange').innerText = q["10. change percent"];
                    updateUI();
                }
            } catch(e) { console.error("Price error"); }
        }

        function trade(type) {
            const qty = parseInt(document.getElementById('tradeQty').value);
            const cost = qty * currentPrice;

            if(type === 'BUY') {
                if(state.cash < cost) return alert("No cash!");
                state.cash -= cost;
                let p = state.portfolio.find(x => x.sym === currentSym);
                if(p) { p.avg = ((p.qty * p.avg) + cost)/(p.qty + qty); p.qty += qty; }
                else { state.portfolio.push({sym: currentSym, qty, avg: currentPrice}); }
            } else {
                let p = state.portfolio.find(x => x.sym === currentSym);
                if(!p || p.qty < qty) return alert("Not enough shares!");
                state.cash += cost;
                p.qty -= qty;
                if(p.qty === 0) state.portfolio = state.portfolio.filter(x => x.sym !== currentSym);
            }

            state.history.unshift({ time: new Date().toLocaleTimeString(), type, sym: currentSym, qty, price: currentPrice });
            updateUI();
            localStorage.setItem('nv_v3', JSON.stringify(state));
        }

        function updateUI() {
            document.getElementById('balanceDisp').innerText = `$${state.cash.toLocaleString()}`;
            document.getElementById('posBody').innerHTML = state.portfolio.map(p => `
                <tr><td>${p.sym}</td><td>${p.qty}</td><td>$${p.avg.toFixed(2)}</td><td>$${(p.qty * currentPrice).toFixed(2)}</td><td style="color:var(--success)">+$0.00</td></tr>
            `).join('');
            document.getElementById('histBody').innerHTML = state.history.map(h => `
                <tr><td>${h.time}</td><td style="color:${h.type==='BUY'?'var(--success)':'var(--danger)'}">${h.type}</td><td>${h.sym}</td><td>${h.qty}</td><td>$${h.price.toFixed(2)}</td></tr>
            `).join('');
        }

        function switchTab(t) {
            document.getElementById('posTable').style.display = t === 'pos' ? 'table' : 'none';
            document.getElementById('histTable').style.display = t === 'hist' ? 'table' : 'none';
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }

        function updateChart() {
            const val = document.getElementById('tickerInput').value.toUpperCase();
            if(val) loadChart(val);
        }

        // Initial Load
        loadChart("AAPL");
    </script>
</body>
</html>